# AI Assistant Rules for LUCA Codebase

## üö® CRITICAL RULES - READ BEFORE MAKING CHANGES

### 1. NEVER Delete Code Without Verification
- ‚úÖ Check if code is used elsewhere with `grep` or `codebase_search`
- ‚úÖ Never delete exports without checking imports
- ‚úÖ Never remove entire functions/sections without confirmation
- ‚úÖ Show user what will be deleted BEFORE deleting

### 2. Always Make Incremental Changes
- ‚úÖ One file at a time
- ‚úÖ One feature at a time
- ‚úÖ Test after each change
- ‚úÖ Show progress after each step

### 3. Preserve Existing Functionality
- ‚úÖ ADD new code, don't REPLACE existing code
- ‚úÖ Don't refactor while adding features
- ‚úÖ Maintain backward compatibility
- ‚úÖ Keep all existing exports

### 4. Always Read First
- ‚úÖ Read the entire file before modifying
- ‚úÖ Understand the structure
- ‚úÖ Check for related files
- ‚úÖ Verify dependencies

### 5. Show Plans Before Execution
For large changes (>100 lines):
- ‚úÖ Show what files will be modified
- ‚úÖ Show what code will be added/removed
- ‚úÖ Confirm no deletions without verification
- ‚úÖ Wait for user approval before proceeding

### 6. File Size Awareness
- ‚úÖ Check file sizes before and after changes
- ‚úÖ Alert if file size decreases significantly
- ‚úÖ Never truncate files without explicit request

### 7. Schema & Tool Consistency
- ‚úÖ Every tool in geminiService.ts needs a schema in schemas.ts
- ‚úÖ Every tool needs a handler in App.tsx (if needed)
- ‚úÖ Every tool needs an endpoint in server.js (if needed)
- ‚úÖ Verify all three when adding tools

### 8. Type Safety
- ‚úÖ Maintain TypeScript types
- ‚úÖ Don't use `any` without good reason
- ‚úÖ Check for type errors with `read_lints`
- ‚úÖ Fix linter errors immediately

---

## üìã Change Request Workflow

### When User Requests Feature:

1. **Analyze Request**
   - Understand what needs to be added
   - Identify all files that need changes
   - Check for similar existing implementations

2. **Create Plan**
   - List files to modify
   - List what will be added
   - List what (if anything) will be removed
   - Show user the plan

3. **Execute Incrementally**
   - Modify one file at a time
   - Test after each file
   - Show progress
   - Wait for confirmation before next file

4. **Verify**
   - Run linter
   - Check for errors
   - Verify imports work
   - Confirm file sizes make sense

---

## üõ°Ô∏è Safety Checks Before Committing

Before suggesting code changes, verify:

- [ ] File exists and is readable
- [ ] I understand the current implementation
- [ ] I know where code is used
- [ ] Changes are incremental
- [ ] No existing code deleted (unless verified unused)
- [ ] All imports preserved
- [ ] All exports preserved
- [ ] TypeScript types maintained
- [ ] Linter will pass

---

## ‚ö†Ô∏è Red Flags - STOP and Ask User

1. **Large file size reduction** (>10% decrease)
2. **Many files changed** (>5 files)
3. **Deletions** (any deletions without verification)
4. **Breaking changes** (changing function signatures)
5. **Restructuring** (moving code around)
6. **Refactoring** (changing implementation style)

---

## ‚úÖ Safe Change Patterns

### Adding a New Tool (Safe Pattern)

```typescript
// 1. Add schema FIRST (schemas.ts)
export const ToolSchemas = {
    // ... existing schemas ...
    newTool: z.object({
        param: z.string()
    })
};

// 2. Add tool definition (geminiService.ts)
export const newTool: FunctionDeclaration = {
    name: 'newTool',
    description: '...',
    parameters: { ... }
};

// 3. Add to allTools array
export const allTools = [
    // ... existing tools ...
    newTool
];

// 4. Add handler if needed (App.tsx)
if (name === 'newTool') {
    // handler code
}

// 5. Add endpoint if needed (server.js)
app.post('/api/new-tool', (req, res) => {
    // endpoint code
});
```

### Modifying Existing Code (Safe Pattern)

```typescript
// BAD - Deletes existing code
function oldFunction() {
    // delete everything
    return newImplementation();
}

// GOOD - Preserves and extends
function oldFunction() {
    // ... existing code preserved ...
    // Add new functionality
    return enhancedImplementation();
}
```

---

## üìù Communication Template

When making changes, use this format:

```
I'll add [FEATURE] by:

1. Modifying [file1.ts] - Adding [X]
2. Modifying [file2.ts] - Adding [Y]
3. Testing [how I'll test]

No existing code will be deleted.
All imports/exports will be preserved.

Should I proceed?
```

---

## üîÑ Recovery Instructions

If something goes wrong:

1. **Stop immediately**
2. **Tell user what happened**
3. **Suggest recovery options:**
   - Revert specific file
   - Use git to restore
   - Manual fix steps

---

**Remember**: Better to ask 10 times than break code once!

